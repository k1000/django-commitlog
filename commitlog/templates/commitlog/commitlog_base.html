{% extends "admin/base_site.html" %}

{% block breadcrumbs %}
<div class="breadcrumbs">
	<ul>
		{% if repo_name %}
		<li>project "<a href="{% url commitlog-repos %}" >{{ repo_name }}</a>" </li>
		{% endif %}
		{% if branch_name %}
		<li>branch "<a class="ajax" rel="main" href="{% url commitlog-tree-view repo_name branch_name "" %}"  >{{ branch_name }}</a>" </li>	
		{% endif %}
		{% if repo_name and branch_name %}
		<li><a class="ajax" rel="main" href="{% url commitlog-branch repo_name branch_name %}"  >commits</a> </li>
		{% endif %}
{% block git_breadcrumbs %}{% endblock git_breadcrumbs %}
	</ul>
</div>

{% if repo_name and branch_name %}
<form method="post" action="{% url commitlog-search repo_name branch_name %}" class="serch_form">
	<p>
		<input type="text" name="query" id="id_query" value="{{ query }}" /> 
		<button>SEARCH</button>
		{% csrf_token %}
	</p>
</form>
<a href="{% url commitlog-undo repo_name branch_name %}" class="undo button" title="undo last commit">undo</a>
{% endif %}
{% endblock breadcrumbs %}



{% block content %}
<link rel="stylesheet" type="text/css" href="{{ GITTER_MEDIA_URL }}commitlog/css/admin.css" />
<link rel="stylesheet" type="text/css" href="{{ GITTER_MEDIA_URL }}commitlog/CodeMirror-2.12/lib/codemirror.css" /> 
<link rel="stylesheet" type="text/css" href="{{ GITTER_MEDIA_URL }}commitlog/css/theme_dark.css" />

<div class="gitter">
	<p><a href="#" id="toogle_files" class="toggle" rel="#tree">Files:</a></p>
	<div id="tree">
{% block git_tree %}{% endblock git_tree %}
	</div>

	
	<div id="main">
	<ul class="tabs"></ul>
{% block git_content %}{% endblock git_content %}
	</div>

	<div id="toolbox">
	</div>
	
	<div id="console">
		<h4>Console</h4>

		<div id="console_output">
		</div>
		<p>
				<label for="console-input">Command</label>
				<input id="console-input" type="text"  />
				<button id="console_enter">ENTER</button>
		</p>
	</div>
</div> 



<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ GITTER_MEDIA_URL }}commitlog/js/jquery.history.js"></script>

<script type="text/javascript" src="{{ GITTER_MEDIA_URL }}commitlog/js/script.js"></script>
<script type="text/javascript" src="{{ GITTER_MEDIA_URL }}commitlog/CodeMirror-2.12/lib/codemirror.js"></script>
<script type="text/javascript" src="{{ GITTER_MEDIA_URL }}commitlog/CodeMirror-2.12/lib/runmode.js"></script>
<script type="text/javascript" src="{{ GITTER_MEDIA_URL }}commitlog/CodeMirror-2.12/lib/overlay.js"></script>


<script type="text/javascript">

function TabManager( tab_container, pages ){
	this.tab_container = tab_container;
	this.pages = pages;
	var self = this;
	tab_container.delegate("li", 'click', function(event){
		event.preventDefault();
		self.deactivate_tabs();
		var tab = $(this);
		tab.addClass("active");
		self.pages.hide_current();
		self.pages.show_page(tab.find("a.tab").attr("href"));
		return false;
	});

	this.mk_tab = function( url, title ){
		this.deactivate_tabs();
		return this.tab_container.append("<li class='active' ><a href='" + url + "' title='"+ title +"' class='tab' >" + title + "</a><a href='#' class='close' >close</a></li>")
	}
	this.rm_tab = function( url ){
		this.get_tab_by_url( url ).parent().remove();
	}
	this.deactivate_tabs = function( ){
		this.tab_container.find("li").removeClass("active");
	}
	this.get_tab_by_url = function( url ){
		return this.tab_container.find("a.[href='" + url +"']")
	}
	this.activate_tab = function( url ){
		this.deactivate_tabs();
		this.get_tab_by_url( url ).parent().addClass("active");
	}
}


function PageManager( page_container, options ){

	this.current = "";
	this.page_container = page_container;
	this.pages = {};
	this.transition = false;
	this.new_page = function( url, data ){
		var id = this.mk_page_id( url );
		this.pages[url] = id;
		this.set_current( url );
        //url = url.replace(/^.*#/, '');
        //$.history.load(url);
		return this.page_container.append("<div class='page' id='" + id + "' >" + data + "</div>");
	}
	this.rm_page = function( url ){
		$("#"+this.get_page_id(url)).remove();
		delete this.pages[url]
	}
	this.mk_page_id = function( url ){
		return url.replace(/\//g, "_").replace(/\./g, "").replace(/:/g, "")
	}
	this.set_current = function( url ){
		this.current = url;
	}
	this.get_page_id = function( url ){
		return this.pages[url]
	}
	this.get_current_id = function( ){
		return this.pages[ this.current ]
	}
	this.get_page = function( url ){
		return $("#"+this.pages[ url ])
	}
	this.get_current = function( ){
		return $("#"+this.pages[ this.current ])
	}
	this.hide_current = function( ){
		var page = this.get_current( );
		this.transition = true;
		var self = this;
		var url = url;
		return page.hide('slide', {direction: 'left'}, 700, function(){
			self.transition = false;
		});
	}
	this.show_page = function( url ){
		var page = this.get_page( url );
		this.set_current( url );
		page.show();
	}
}



$(document).ready( function(){
	// initialize from history
	//http://tkyk.github.com/jquery-history-plugin/#demos
	function loadContent(hash) {
	    if(hash != "") {
	        //pages.new_page( hash +".html" );
	    } else {
	    	
	    	
		}
	}
	// initialize pages
	var pages = new PageManager($("#main"));
	var tabs = new TabManager($("ul.tabs"), pages);
	pages.new_page( document.location.href );
	// give current page id
	$(".page").attr("id", pages.mk_page_id( document.location.href ) );
	tabs.mk_tab( document.location.href , "kkkkk");
	//$.history.init(loadContent);
	// initialize tabs

{% if repo_name and branch_name %}

	// ----------------- CONSOLE --------------------
	$("#console_enter").click(function( ){
		var data = {"com":"git status"};
		$('#console_output').load("{% url commitlog-consol repo_name %}", data, function() {
		  
		});
	})

	// ----------------- TREE INIT --------------------
	var tree_path =  {% if path %} '{% url commitlog-tree-view repo_name branch_name path %}';
	{% else %} '{% url commitlog-tree-view repo_name branch_name "" %}'; {% endif %}
	
	$("#tree").load(tree_path);
{% endif %}
	
	// ----------------- FILES --------------------
	$("#toogle_files").click( function(event){
		event.preventDefault();
		$(this).removeClass("open").addClass("closed");
		$('#tree').toggle("fast");
	})

	// ----------------- NEW FILE --------------------
	$("#create_new_file").click( function(){
		var loc = document.getElementById("cur_path").value + "/" +
			document.getElementById("new_file_name").value;
		document.location = loc;
	})

	// ----------------- PAGES --------------------

	$('#content').delegate('a.ajax', 'click', function(event) {
		event.preventDefault();
		
		if (this.rel == "#main") {
			// if its the same page do nothing
			if ( this.href != pages.current) {
				// hide current page
				pages.hide_current();
				//show if page is already loaded
				if ( pages.pages[this.href] ){
					tabs.activate_tab(this.href);
					pages.show_page(this.href);
				//creat new page
				} else { 
					var self = this;
					$.get(this.href, function(data) {
						pages.new_page(self.href, data );
					  	// --------------- tabs -------------------
					  	tabs.mk_tab(self.href, $(data).find("h1").html());
					}, "html")
				}				
			}
		}else {
			$(this.rel).load(this.href, function() {
		  		console.log(this.href)
			});
		}
		return false;
	});
		
})

</script>
{% block js %}{% endblock js %}

{% endblock content %}